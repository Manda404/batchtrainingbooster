name: CI - BatchTrainingBooster

on:
  push:                       # üöÄ Lancement sur push
    branches: [ main, feature/* ]
  pull_request:               # üîÅ Lancement sur PR
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest    # üêß Runner GitHub (Linux)

    steps:
      # 1) üìÇ R√©cup√©ration du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) üêç Installation de Python (3.11, comme ton pyproject.toml)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) ‚òï Installation de Java (n√©cessaire pour PySpark)
      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin   # OpenJDK Temurin (stable et gratuit)
          java-version: "11"

      # 4) üì¶ Installation de Poetry
      - name: Install Poetry
        uses: abatilo/actions-poetry@v3
        with:
          poetry-version: "1.8.3"

      # 5) ‚öôÔ∏è Configuration de l'environnement virtuel Poetry
      - name: Configure Poetry virtualenv
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry --version

      # 6) üß† Mise en cache du venv + d√©pendances Poetry
      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-py311-poetry1.8.3-${{ hashFiles('**/poetry.lock') }}-v3
          restore-keys: |
            ${{ runner.os }}-py311-poetry1.8.3-

      # 7) üì• Installation des d√©pendances + ton package (src layout)
      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      # 8) üé® V√©rification qualit√© du code (facultatif si tu veux du linting)
      - name: Run code quality checks
        run: |
          # V√©rifications en CI ===> V√©rification du formatage
          poetry run black --check src tests
          poetry run ruff format --check src tests

          # V√©rification du linting
          poetry run ruff check src tests

          # V√©rification des types
          poetry run mypy src tests

      # 9) üß™ Lancement des tests unitaires avec PySpark + pytest
      - name: Run unit tests
        env:
          PYSPARK_PYTHON: python  # Simplifi√© - Poetry g√®re d√©j√† l'env
          SPARK_LOCAL_IP: 127.0.0.1
          # √âvite les warnings PySpark en CI
          PYTHONPATH: ${{ github.workspace }}/src
        run: poetry run pytest -v --maxfail=1 --disable-warnings