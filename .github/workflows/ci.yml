name: CI - BatchTrainingBooster

on:
  push:                       # ğŸš€ Lancement sur push
    branches: [ main, feature/* ]
  pull_request:               # ğŸ” Lancement sur PR
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest    # ğŸ§ Runner GitHub (Linux)

    steps:
      # 1) ğŸ“‚ RÃ©cupÃ©ration du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) ğŸ Installation de Python (3.11, comme ton pyproject.toml)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) â˜• Installation de Java (nÃ©cessaire pour PySpark)
      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin   # OpenJDK Temurin (stable et gratuit)
          java-version: "11"

      # 4) ğŸ“¦ Installation de Poetry
      - name: Install Poetry
        uses: abatilo/actions-poetry@v3
        with:
          poetry-version: "1.8.3"

      # 5) âš™ï¸ Configuration de l'environnement virtuel Poetry
      - name: Configure Poetry virtualenv
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry --version

      # 6) ğŸ§  Mise en cache du venv + dÃ©pendances Poetry
      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-py311-poetry1.8.3-${{ hashFiles('**/poetry.lock') }}-v2
          restore-keys: |
            ${{ runner.os }}-py311-poetry1.8.3-

      # 7) ğŸ“¥ Installation des dÃ©pendances + ton package (src layout)
      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      # 8) ğŸ¨ VÃ©rification qualitÃ© du code (facultatif si tu veux du linting)
      - name: Run code quality checks
        run: |
          poetry run black --check src tests
          poetry run isort --check-only src tests
          poetry run mypy src

      # 9) ğŸ§ª Lancement des tests unitaires avec PySpark + pytest
      - name: Run unit tests
        env:
          PYSPARK_PYTHON: ${{ github.workspace }}/.venv/bin/python  # Force PySpark Ã  utiliser le venv Poetry
          SPARK_LOCAL_IP: 127.0.0.1                                # Ã‰vite les warnings de loopback
        run: poetry run pytest -v --maxfail=1 --disable-warnings
