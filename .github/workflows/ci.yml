name: CI - BatchTrainingBooster

on:
  push:                       # 🚀 Lancement sur push
    branches: [ main, feature/* ]
  pull_request:               # 🔁 Lancement sur PR
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest    # 🐧 Runner GitHub (Linux)

    steps:
      # 1) 📂 Récupération du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) 🐍 Installation de Python (3.11, comme ton pyproject.toml)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3) ☕ Installation de Java (nécessaire pour PySpark)
      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin   # OpenJDK Temurin (stable et gratuit)
          java-version: "11"

      # 4) 📦 Installation de Poetry
      - name: Install Poetry
        uses: abatilo/actions-poetry@v3
        with:
          poetry-version: "1.8.3"

      # 5) ⚙️ Configuration de l'environnement virtuel Poetry
      - name: Configure Poetry virtualenv
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true
          poetry --version

      # 6) 🧠 Mise en cache du venv + dépendances Poetry
      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-py311-poetry1.8.3-${{ hashFiles('**/poetry.lock') }}-v2
          restore-keys: |
            ${{ runner.os }}-py311-poetry1.8.3-

      # 7) 📥 Installation des dépendances + ton package (src layout)
      - name: Install dependencies
        run: poetry install --no-interaction --no-ansi

      # 8) 🎨 Vérification qualité du code (facultatif si tu veux du linting)
      - name: Run code quality checks
        run: |
          poetry run black --check src tests
          poetry run isort --check-only src tests
          poetry run mypy src

      # 9) 🧪 Lancement des tests unitaires avec PySpark + pytest
      - name: Run unit tests
        env:
          PYSPARK_PYTHON: ${{ github.workspace }}/.venv/bin/python  # Force PySpark à utiliser le venv Poetry
          SPARK_LOCAL_IP: 127.0.0.1                                # Évite les warnings de loopback
        run: poetry run pytest -v --maxfail=1 --disable-warnings
